<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>Joining Room...</title>

    <script src="https://code.bdstatic.com/npm/leancloud-realtime@5.0.0-rc.7/dist/im-browser.min.js"></script>

    <script src="https://unpkg.com/vue@3.2.40/dist/vue.global.prod.js"></script>

    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/customParseFormat.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekday.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/localeData.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekOfYear.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/weekYear.js"></script>
    <script src="https://unpkg.com/dayjs/plugin/advancedFormat.js"></script>
    <script src="https://unpkg.com/ant-design-vue@3.2.12/dist/antd.min.js"></script>
    <link href="https://unpkg.com/ant-design-vue@3.2.12/dist/antd.dark.min.css" rel="stylesheet" />

    <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>

    <style>
        #app {
            width: 800px;
            margin: auto;
        }

        .comment {
            line-height: 20px;
            font-size: 32px;
            position: absolute;
            white-space: nowrap;
            pointer-events: none;
        }

        .user-0 {
            color: #FFC9D8 !important;
            text-shadow: 0 0 5px #A41F45;
        }

        .user-1 {
            color: #FFF0C4 !important;
            text-shadow: 0 0 5px #9D780C;
        }

        .user-2 {
            color: #BEE8FF !important;
            text-shadow: 0 0 5px #1D4B66;
        }

        .user-3 {
            color: #BEFFE7 !important;
            text-shadow: 0 0 5px #265D49;
        }

        .user-4 {
            color: white !important;
            text-shadow: 0 0 5px black;
        }
    </style>
</head>

<body style="padding: 2em;">
    <div id="app">
        <a-spin size="large" :tip="spinTip" :spinning="spinning">
            <a-typography-title :level="2">
                {{ roomName }}
            </a-typography-title>
            <a-typography-paragraph v-if="roomMembers.length">
                <span v-for="(member, i) in roomMembers"><b :class="`user-${i}`">{{ member }}</b>, </span>
                <span>{{ tr("is in room now.") }}</span>
            </a-typography-paragraph>
            <div id="player">
                <div style="height: 100%;">
                    <div id="video-container"
                        style="overflow: hidden; height: calc(100% - 72px); margin-top: 24px; position: relative;">
                        <video id="my-player" style="min-height: 480px;"
                            class="video-js vjs-default-skin vjs-big-play-centered vjs-fill" controls preload="auto">
                        </video>
                    </div>
                    <div style="padding: 8px 50px;">
                        <a-row type="flex" :gutter="16">
                            <a-col flex="auto">
                                <a-input v-model:value="inputedComment" :placeholder="tr('Press Enter to send')"
                                    @press-enter="sendComment">
                                </a-input>
                            </a-col>
                            <a-col flex="1px">
                                <a-button @click="toggleFullscreen">
                                    {{ fullscreened? "－" : "＋" }}
                                </a-button>
                            </a-col>
                        </a-row>
                    </div>
                </div>
            </div>
        </a-spin>
        <a-modal v-model:visible="modelVisible" :title="tr('Who are you?')" :closable="false" :maskClosable="false"
            :keyboard="false" :mask-closable="false">
            <a-input v-model:value="userName" @press-enter="submitName"></a-input>
            <template #footer>
                <a-button key="ok" type="primary" @click="submitName" :disabled="userName===''">
                    {{ tr("Join!") }}
                </a-button>
            </template>
        </a-modal>
    </div>

    <script>
        const UrlParams = new URLSearchParams(window.location.search);
        let Conversation;
        let User;
        let Player;

        const Strings = {
            "zh-CN": {
                'Who are you?': '你是谁？',
                "Join!": "加入！",
                'Press Enter to send': "按回车发送",
                "is in room now.": "在房间中。",
                "Now Playing: ": "正在播放：",
                "Connecting to server...": "正在连接服务器……",
                "Fetching room information...": "正在获取房间信息……",
                "Joining room...": "正在加入房间……",
                "Loading media...": "正在加载媒体……",
                " joined": " 已加入",
                " lefted": " 已离开",
                " played the video": " 播放了视频",
                " paused the video": " 暂停了视频",
                " adjusted video progress": " 调整了视频进度",
                "Failed to load media.": "加载媒体失败。",
                "Failed to join: Room was closed.": "加入失败：房间已关闭。",
                "Failed to send. Please refresh and try again.": "发送失败。请刷新并重试。",
                "Failed to load. Please refresh and try again.": "载入失败。请刷新并重试。",
            }
        }
        function Tr(s) {
            const localStrings = Strings[navigator.language];
            if (localStrings && localStrings[s]) return localStrings[s];
            return s;
        }

        const AudioNewMessage = new Audio("https://lc-gluttony.s3.amazonaws.com/rnC1ehKEjnxd/LlNb883xU2ggHcHMnzwQlPiRrOikEPRx/new_message.ogg");
        const AudioMemberJoined = new Audio("https://lc-gluttony.s3.amazonaws.com/rnC1ehKEjnxd/W21QmrEYPBrAtYtcw83ogCtKQKQrxWiI/member_joined.ogg");

        antd.message.config({
            top: '50px',
            getContainer: () => document.getElementById("my-player"),
        });

        Vue.createApp({
            data() {
                return {
                    userName: "",
                    modelVisible: false,
                    roomName: "",
                    roomMembers: [],
                    comments: [],
                    inputedComment: "",
                    spinning: true,
                    spinTip: "",
                    fullscreened: false,
                }
            },
            methods: {
                showModal() {
                    this.dialogVisible = true;
                },
                submitName() {
                    this.modelVisible = false;
                    this.login();
                },
                login() {
                    this.spinTip = Tr("Connecting to server...");

                    const realtime = new AV.Realtime({
                        appId: 'rnC1ehKEjnxdhaYDUyZ3lg4p-MdYXbMMI',
                        appKey: UrlParams.get("key"),
                    });

                    this.userName = this.userName.trim();
                    realtime.createIMClient(this.userName).then(user => {
                        this.spinTip = Tr("Fetching room information...");

                        User = user;

                        user.on(AV.Event.MESSAGE, (message, conversation) => {
                            if (Player.paused()) {
                                AudioNewMessage.play();
                            }
                            this.showComment(message.text, message.from);
                        });
                        user.on(AV.Event.MEMBERS_JOINED, (payload, conversation) => {
                            if (conversation.id === Conversation.id) {
                                if (Player.paused()) {
                                    AudioMemberJoined.play();
                                }
                                antd.message.success(payload.members.toString() + Tr(" joined"));
                                for (let member of payload.members) {
                                    if (member === this.userName) continue;
                                    this.roomMembers.push(member);
                                }
                            }
                        });
                        user.on(AV.Event.MEMBERS_LEFT, (payload, conversation) => {
                            if (conversation.id === Conversation.id) {
                                antd.message.info(payload.members.toString() + Tr(" lefted"));
                                for (let leftMember of payload.members) {
                                    for (let i in this.roomMembers) {
                                        if (this.roomMembers[i] === leftMember) {
                                            this.roomMembers.splice(i, 1);
                                            break;
                                        }
                                    }
                                }
                            }
                        });
                        user.on(AV.Event.CONVERSATION_INFO_UPDATED, payload => {
                            console.log(payload);
                            if (payload.updatedBy !== this.userName) {
                                if (Conversation.get("videoState") === "play") {
                                    if (Player.paused()) {
                                        antd.message.open({ content: payload.updatedBy + Tr(" played the video") });
                                    } else if (!this.videoPositionMatched()) {
                                        antd.message.open({ content: payload.updatedBy + Tr(" adjusted video progress") });
                                    }
                                } else if (Conversation.get("videoState") === "pause") {
                                    antd.message.open({ content: payload.updatedBy + Tr(" paused the video") });
                                }
                                this.syncConversationState();
                            }
                        });

                        const query = User.getQuery();
                        query.equalTo("roomNumber", UrlParams.get("room"));
                        return query.first();
                    }).then(conversation => {
                        if (!conversation) {
                            return Promise.reject(new Error(Tr("Failed to join: Room was closed.")));
                        }
                        Conversation = conversation;

                        this.spinTip = Tr("Joining room...");

                        return conversation.join();
                    }).then(conversation => {
                        this.spinTip = Tr("Loading media...");

                        this.roomName = Tr("Now Playing: ") + conversation.name;
                        document.title = this.roomName

                        for (let member of conversation.members) {
                            if (member === this.userName) {
                                this.roomMembers.unshift(member);
                            } else {
                                this.roomMembers.push(member);
                            }
                        }

                        Player = videojs('my-player', {
                            "userActions": { "doubleClick": false },
                            "controlBar": { "fullscreenToggle": false }
                        });
                        Player.src({
                            src: conversation.get('videoUrl'),
                            type: "application/x-mpegURL"
                        });
                        Player.ready(() => {
                            this.syncConversationState();
                            Player.on("play", () => {
                                if (Conversation.get("videoState") !== "play") {
                                    Conversation.set("videoState", "play");
                                    Conversation.set("videoPosition", Player.currentTime());
                                    Conversation.set("videoTimestampMs", Date.now());
                                    Conversation.save();
                                }
                            });
                            Player.on("pause", () => {
                                if (Conversation.get("videoState") !== "pause") {
                                    Conversation.set("videoState", "pause");
                                    Conversation.set("videoPosition", Player.currentTime());
                                    Conversation.set("videoTimestampMs", Date.now());
                                    Conversation.save();
                                }
                            });
                            Player.on("seeked", () => {
                                if (!Player.paused() && !this.videoPositionMatched()) {
                                    Conversation.set("videoState", "play");
                                    Conversation.set("videoPosition", Player.currentTime());
                                    Conversation.set("videoTimestampMs", Date.now());
                                    Conversation.save();
                                }
                            });
                            Player.on("canplaythrough", () => {
                                this.spinning = false;
                            });
                            Player.on("error", () => {
                                this.spinTip = Tr("Failed to load media.");
                            });
                        });
                    }).catch(err => {
                        console.error(err);
                        this.spinTip = err.toString();
                    });
                },
                remoteCurrentTime() {
                    return Conversation.get("videoPosition") + (Date.now() - Conversation.get("videoTimestampMs")) / 1000;
                },
                videoPositionMatched() {
                    return Math.abs(this.remoteCurrentTime() - Player.currentTime()) < 3;
                },
                toggleFullscreen() {
                    if (!document.fullscreenElement) {
                        document.getElementById("player").requestFullscreen().then(() => {
                        }).catch((err) => {
                            alert(`Error attempting to enable fullscreen mode: ${err.message} (${err.name})`);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                },
                showComment(commentText, from) {
                    from = from || this.userName;
                    let userIndex;
                    for (userIndex in this.roomMembers) {
                        if (this.roomMembers[userIndex] === from) break;
                    }

                    const e = document.createElement("div");
                    const container = document.getElementById("video-container")
                    e.classList.add("comment", "user-" + userIndex);
                    e.style.left = container.offsetWidth + "px";
                    e.innerHTML = commentText;

                    let inserted = false;
                    for (let i in this.comments) {
                        if (!this.comments[i].parentElement) {
                            e.style.top = `calc(20% + ${40 * i}px)`;
                            this.comments[i] = e;
                            inserted = true;
                            break;
                        }
                    }
                    if (!inserted) {
                        e.style.top = `calc(20% + ${40 * this.comments.length}px)`;
                        this.comments.push(e);
                    }

                    requestAnimationFrame(function render() {
                        e.style.left = parseInt(e.style.left) - 2 + 'px';
                        if (e.offsetLeft + e.offsetWidth < 0) {
                            e.remove();
                        } else {
                            requestAnimationFrame(render);
                        }
                    });
                    container.appendChild(e);
                },
                sendComment() {
                    let comment = this.inputedComment.trim();
                    this.inputedComment = "";

                    if (comment) {
                        Conversation.send(new AV.TextMessage(comment)).then(() => {
                            this.showComment(comment);
                        }).catch(err => {
                            console.error(err);
                            antd.message.error(Tr("Failed to send. Please refresh and try again."));
                        });
                    }
                },
                syncConversationState() {
                    if (Conversation.get("videoState") === "play") {
                        if (!this.videoPositionMatched()) {
                            Player.currentTime(this.remoteCurrentTime());
                        }
                        Player.play();
                    } else if (Conversation.get("videoState") === "pause") {
                        Player.pause();
                        Player.currentTime(Conversation.get("videoPosition"));
                    }
                },
                tr(string) {
                    return Tr(string);
                },
            },
            mounted() {
                document.getElementById("player").addEventListener('fullscreenchange', event => {
                    this.fullscreened = document.fullscreenElement ? true : false;
                });
                if (!UrlParams.has("user")) {
                    this.modelVisible = true;
                } else {
                    this.userName = UrlParams.get("user");
                    this.login();
                }
            },
        }).use(antd).mount('#app')

        window.onbeforeunload = event => {
            if (Conversation) Conversation.quit();
        }
    </script>
</body>

</html>
